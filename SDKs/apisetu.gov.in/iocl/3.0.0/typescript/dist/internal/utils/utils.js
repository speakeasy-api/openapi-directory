"use strict";
/*
 * Code generated by Speakeasy (https://speakeasyapi.dev). DO NOT EDIT.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.populateFromGlobals = exports.getResFieldDepth = exports.objectToClass = exports.encodeAndConvertPrimitiveVal = exports.convertIfDateObjectToISOString = exports.isEmpty = exports.isBooleanRecord = exports.isNumberRecord = exports.isStringRecord = exports.parseParamDecorator = exports.generateURL = exports.templateUrl = exports.SpeakeasyMetadata = exports.ParamDecorator = exports.SpeakeasyBase = exports.SerializationMethodToContentType = void 0;
require("reflect-metadata");
var pathparams_1 = require("./pathparams");
var class_transformer_1 = require("class-transformer");
var requestbody_1 = require("./requestbody");
exports.SerializationMethodToContentType = {
    json: "application/json",
    form: "application/x-www-form-urlencoded",
    multipart: "multipart/form-data",
    raw: "application/octet-stream",
    string: "text/plain",
};
function isSpeakeasyBase(type) {
    var _a;
    return type && ((_a = Object.getPrototypeOf(type)) === null || _a === void 0 ? void 0 : _a.name) == "SpeakeasyBase";
}
function handleArray(value, elemType, elemDepth) {
    if (!Array.isArray(value)) {
        return value;
    }
    if (elemDepth == 1) {
        return value.map(function (v) { return new elemType(v); });
    }
    else {
        return value.map(function (v) {
            if (Array.isArray(v)) {
                return handleArray(v, elemType, elemDepth - 1);
            }
            else if (typeof v == "object") {
                return handleObject(v, elemType, elemDepth - 1);
            }
            else {
                return v;
            }
        });
    }
}
function handleObject(value, elemType, elemDepth) {
    if (typeof value != "object") {
        return value;
    }
    if (elemDepth == 1) {
        return Object.keys(value).reduce(function (acc, key) {
            acc[key] = new elemType(value[key]);
            return acc;
        }, {});
    }
    else {
        return Object.keys(value).reduce(function (acc, key) {
            var v = value[key];
            if (Array.isArray(v)) {
                acc[key] = handleArray(v, elemType, elemDepth - 1);
            }
            else if (typeof v == "object") {
                acc[key] = handleObject(v, elemType, elemDepth - 1);
            }
            else {
                acc[key] = v;
            }
            return acc;
        }, {});
    }
}
var SpeakeasyBase = /** @class */ (function () {
    function SpeakeasyBase(payload) {
        var props = this["__props__"];
        if (props) {
            for (var _i = 0, props_1 = props; _i < props_1.length; _i++) {
                var prop = props_1[_i];
                if (payload && payload.hasOwnProperty(prop.key)) {
                    var value = payload[prop.key];
                    if (isSpeakeasyBase(prop.type)) {
                        this[prop.key] = new prop.type(value);
                    }
                    else if (prop.type.name == "Array" &&
                        isSpeakeasyBase(prop.elemType)) {
                        this[prop.key] = handleArray(value, prop.elemType, prop.elemDepth);
                    }
                    else if (prop.type.name == "Object" &&
                        isSpeakeasyBase(prop.elemType)) {
                        this[prop.key] = handleObject(value, prop.elemType, prop.elemDepth);
                    }
                    else {
                        this[prop.key] = value;
                    }
                }
            }
        }
    }
    return SpeakeasyBase;
}());
exports.SpeakeasyBase = SpeakeasyBase;
var ParamDecorator = /** @class */ (function () {
    function ParamDecorator(Style, Explode, ParamName, Serialization, DateTimeFormat) {
        this.Style = Style;
        this.Explode = Explode;
        this.ParamName = ParamName;
        this.Serialization = Serialization;
        this.DateTimeFormat = DateTimeFormat;
    }
    return ParamDecorator;
}());
exports.ParamDecorator = ParamDecorator;
function SpeakeasyMetadata(params) {
    return function (target, propertyKey) {
        if (params === null || params === void 0 ? void 0 : params.data) {
            var annsArr = params.data.split(", ");
            for (var i = 0; i < annsArr.length; i += 2) {
                Reflect.defineMetadata(annsArr[i], annsArr[i + 1], target, propertyKey);
            }
        }
        var props;
        if (target.hasOwnProperty("__props__")) {
            props = target["__props__"];
        }
        else {
            props = target["__props__"] = [];
        }
        var prop = {
            key: propertyKey,
            type: Reflect.getMetadata("design:type", target, propertyKey),
        };
        if (params === null || params === void 0 ? void 0 : params.elemType) {
            prop.elemType = params.elemType;
            prop.elemDepth = params.elemDepth || 1;
        }
        props.push(prop);
    };
}
exports.SpeakeasyMetadata = SpeakeasyMetadata;
function templateUrl(stringWithParams, params) {
    var res = stringWithParams;
    Object.entries(params).forEach(function (_a) {
        var key = _a[0], value = _a[1];
        var match = "{" + key + "}";
        res = res.replaceAll(match, value);
    });
    return res;
}
exports.templateUrl = templateUrl;
function generateURL(serverURL, path, pathParams, globals) {
    var url = serverURL.replace(/\/$/, "") + path;
    var parsedParameters = {};
    var fieldNames = "__props__" in pathParams
        ? pathParams["__props__"].map(function (prop) { return prop.key; })
        : Object.getOwnPropertyNames(pathParams);
    fieldNames.forEach(function (fname) {
        var requestBodyAnn = Reflect.getMetadata(requestbody_1.requestMetadataKey, pathParams, fname);
        if (requestBodyAnn)
            return;
        var ppAnn = Reflect.getMetadata(pathparams_1.ppMetadataKey, pathParams, fname);
        if (ppAnn == null)
            return;
        var ppDecorator = parseParamDecorator(ppAnn, fname, "simple", false);
        if (ppDecorator == null)
            return;
        var value = pathParams[fname];
        value = populateFromGlobals(value, fname, "pathParam", globals);
        switch (ppDecorator.Style) {
            case "simple": {
                var simpleParams = (0, pathparams_1.getSimplePathParams)(ppDecorator.ParamName, value, ppDecorator.Explode, ppDecorator.DateTimeFormat);
                simpleParams.forEach(function (value, key) {
                    parsedParameters[key] = value;
                });
            }
        }
    });
    return templateUrl(url, parsedParameters);
}
exports.generateURL = generateURL;
function parseParamDecorator(ann, fName, defaultStyle, defaultExplode) {
    // style=simple;explode=false;name=apiID
    var decorator = new ParamDecorator(defaultStyle, defaultExplode, fName.toLowerCase());
    if (ann == null)
        return decorator;
    ann.split(";").forEach(function (annPart) {
        var _a = annPart.split("="), paramKey = _a[0], paramVal = _a[1];
        switch (paramKey) {
            case "style":
                decorator.Style = paramVal;
                break;
            case "explode":
                decorator.Explode = paramVal == "true";
                break;
            case "name":
                decorator.ParamName = paramVal;
                break;
            case "serialization":
                decorator.Serialization = paramVal;
                break;
            case "dateTimeFormat":
                decorator.DateTimeFormat = paramVal;
        }
    });
    return decorator;
}
exports.parseParamDecorator = parseParamDecorator;
function isStringRecord(obj) {
    if (typeof obj !== "object")
        return false;
    if (Object.getOwnPropertySymbols(obj).length > 0)
        return false;
    return Object.getOwnPropertyNames(obj).every(function (prop) { return typeof obj[prop] === "string"; });
}
exports.isStringRecord = isStringRecord;
function isNumberRecord(obj) {
    if (typeof obj !== "object")
        return false;
    if (Object.getOwnPropertySymbols(obj).length > 0)
        return false;
    return Object.getOwnPropertyNames(obj).every(function (prop) { return typeof obj[prop] === "number"; });
}
exports.isNumberRecord = isNumberRecord;
function isBooleanRecord(obj) {
    if (typeof obj !== "object")
        return false;
    if (Object.getOwnPropertySymbols(obj).length > 0)
        return false;
    return Object.getOwnPropertyNames(obj).every(function (prop) { return typeof obj[prop] === "boolean"; });
}
exports.isBooleanRecord = isBooleanRecord;
function isEmpty(value) {
    // check for undefined, null, and NaN
    var res = false;
    if (typeof value === "number")
        res = Number.isNaN(value);
    else if (typeof value === "string")
        res = value === "";
    return res || value == null;
}
exports.isEmpty = isEmpty;
// If value is Date type, serialize as ISO string since Date constructor creates from system clock
function convertIfDateObjectToISOString(value, dateTimeFormat) {
    var dtFormat = dateTimeFormat !== null && dateTimeFormat !== void 0 ? dateTimeFormat : "YYYY-MM-DDThh:mm:ss.sssZ";
    if (value instanceof Date) {
        if (dtFormat === "YYYY-MM-DD") {
            var dateRegex = /^(\d{4})-(\d{2})-(\d{2})/;
            var matches = value.toISOString().match(dateRegex);
            if (matches == null) {
                throw new Error("Date format is not valid");
            }
            var year = matches[1], month = matches[2], day = matches[3];
            return "".concat(year, "-").concat(month, "-").concat(day);
        }
        if (dtFormat === "YYYY-MM-DDThh:mm:ss.sssZ") {
            return value.toISOString();
        }
    }
    return value;
}
exports.convertIfDateObjectToISOString = convertIfDateObjectToISOString;
function encodeAndConvertPrimitiveVal(value, dateTimeFormat) {
    return encodeURIComponent(convertIfDateObjectToISOString(value, dateTimeFormat));
}
exports.encodeAndConvertPrimitiveVal = encodeAndConvertPrimitiveVal;
function objectToClass(value, klass, elemDepth) {
    if (elemDepth === void 0) { elemDepth = 0; }
    if (value !== Object(value)) {
        return value;
    }
    if (elemDepth === 0 && klass != null) {
        return (0, class_transformer_1.plainToInstance)(klass, value, {
            excludeExtraneousValues: true,
            exposeUnsetFields: false,
        });
    }
    if (Array.isArray(value)) {
        return value.map(function (v) { return objectToClass(v, klass, elemDepth - 1); });
    }
    if (typeof value === "object" && value != null) {
        var copiedRecord = {};
        for (var key in value) {
            copiedRecord[key] = objectToClass(value[key], klass, elemDepth - 1);
        }
        return copiedRecord;
    }
    return (0, class_transformer_1.plainToInstance)(klass, value, {
        excludeExtraneousValues: true,
        exposeUnsetFields: false,
    });
}
exports.objectToClass = objectToClass;
function getResFieldDepth(res) {
    var props = res["__props__"];
    var resFieldDepth = 1;
    if (props) {
        for (var _i = 0, props_2 = props; _i < props_2.length; _i++) {
            var prop = props_2[_i];
            if (res && res.hasOwnProperty(prop.key)) {
                if ((prop.type.name == "Array" || prop.type.name == "Object") &&
                    isSpeakeasyBase(prop.elemType)) {
                    if (prop.elemDepth > resFieldDepth) {
                        resFieldDepth = prop.elemDepth;
                        break;
                    }
                }
            }
        }
    }
    return resFieldDepth;
}
exports.getResFieldDepth = getResFieldDepth;
function populateFromGlobals(value, fieldName, paramType, globals) {
    if (globals && value === undefined) {
        if ("parameters" in globals && paramType in globals.parameters) {
            var globalValue = globals.parameters[paramType][fieldName];
            if (globalValue !== undefined) {
                value = globalValue;
            }
        }
    }
    return value;
}
exports.populateFromGlobals = populateFromGlobals;
